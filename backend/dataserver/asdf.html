
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#</span>
<span class="c1"># Copyright Â© 2019 Sunho Kim. All rights reserved.</span>
<span class="c1">#</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cd</span> <span class="o">..</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>/gorani/gorani/backend
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="k">import</span> <span class="n">SparkSession</span><span class="p">,</span> <span class="n">DataFrame</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span>\
    <span class="o">.</span><span class="n">builder</span>\
    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s1">&#39;Cluster Books&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># parameters</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">iteration</span> <span class="o">=</span> <span class="mi">100</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Parameters</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.6</span>
<span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.1</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="k">import</span> <span class="n">CountVectorizer</span><span class="p">,</span> <span class="n">Normalizer</span>
<span class="kn">from</span> <span class="nn">pyspark.mllib.linalg.distributed</span> <span class="k">import</span> <span class="n">IndexedRow</span><span class="p">,</span> <span class="n">IndexedRowMatrix</span>

<span class="kn">from</span> <span class="nn">gorani.spark</span> <span class="k">import</span> <span class="n">read_data_all</span><span class="p">,</span> <span class="n">write_data</span>
<span class="kn">from</span> <span class="nn">gorani.utils</span> <span class="k">import</span> <span class="n">sparse_to_array</span>

<span class="n">SIMILARITY_TYPE</span> <span class="o">=</span> <span class="s1">&#39;cosine&#39;</span>

<span class="n">words</span> <span class="o">=</span> <span class="n">read_data_all</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s1">&#39;words&#39;</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">books</span> <span class="o">=</span> <span class="n">read_data_all</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s1">&#39;books&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cv</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">()</span>\
    <span class="o">.</span><span class="n">setInputCol</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">setOutputCol</span><span class="p">(</span><span class="s1">&#39;tf&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">setVocabSize</span><span class="p">(</span><span class="n">words</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">books</span><span class="p">)</span>

<span class="n">nor</span> <span class="o">=</span> <span class="n">Normalizer</span><span class="p">()</span>\
    <span class="o">.</span><span class="n">setInputCol</span><span class="p">(</span><span class="s1">&#39;tf&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">setOutputCol</span><span class="p">(</span><span class="s1">&#39;norm&#39;</span><span class="p">)</span>

<span class="c1"># normalized book-wordcount matrix</span>
<span class="n">tf_mat</span> <span class="o">=</span> <span class="n">nor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">books</span><span class="p">))</span>

<span class="c1"># convert to SparseMatrix to BlockMatrix</span>
<span class="n">mat</span> <span class="o">=</span> <span class="n">IndexedRowMatrix</span><span class="p">(</span>
<span class="n">tf_mat</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;norm&quot;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">IndexedRow</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">toArray</span><span class="p">())))</span>\
    <span class="o">.</span><span class="n">toBlockMatrix</span><span class="p">()</span>

<span class="c1"># cosine similarity</span>
<span class="n">sim_mat_df</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>\
    <span class="o">.</span><span class="n">toIndexedRowMatrix</span><span class="p">()</span>\
    <span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">toDF</span><span class="p">()</span>

<span class="c1"># change schema</span>
<span class="n">sim_af</span> <span class="o">=</span> <span class="n">sim_mat_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">posexplode</span><span class="p">(</span><span class="n">sparse_to_array</span><span class="p">(</span><span class="s1">&#39;vector&#39;</span><span class="p">)))</span>\
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;other_id&#39;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;col&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">))</span>\
    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;id &lt; other_id AND id != 0&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;other_id&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sim mat:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sim_af</span><span class="o">.</span><span class="n">collect</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>sim mat:
[(4, 5, 0.67757248878479), (4, 6, 0.7573773860931396), (1, 2, 0.6806613802909851), (1, 3, 0.6414517760276794), (1, 4, 0.7125809788703918), (1, 5, 0.84701007604599), (1, 6, 0.8728290796279907), (3, 4, 0.9638029932975769), (3, 5, 0.6091843247413635), (3, 6, 0.6786766052246094), (5, 6, 0.8231562972068787), (2, 3, 0.9711453318595886), (2, 4, 0.9739340543746948), (2, 5, 0.6422935128211975), (2, 6, 0.7229636907577515)]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.mllib.clustering</span> <span class="k">import</span> <span class="n">PowerIterationClustering</span><span class="p">,</span> <span class="n">PowerIterationClusteringModel</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="k">import</span> <span class="n">Row</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">PowerIterationClustering</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">sim_af</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">assignments</span><span class="p">()</span><span class="o">.</span><span class="n">toDF</span><span class="p">()</span>

<span class="n">write_data</span><span class="p">(</span><span class="s1">&#39;cluster_books&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
<span class="n">write_data</span><span class="p">(</span><span class="s1">&#39;book_cluster&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">assignments</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;result:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(id cluster)&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">cluster</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>result:
(id cluster)
(4 1)
(1 0)
(6 1)
(3 1)
(5 1)
(2 0)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
 

